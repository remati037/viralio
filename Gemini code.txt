import React, { useState, useEffect } from 'react';
import { 
  Play, 
  TrendingUp, 
  Zap, 
  Copy, 
  Check, 
  Layout, 
  Video, 
  Home, 
  Dumbbell, 
  ShoppingBag, 
  Menu,
  X,
  Lightbulb,
  ArrowRight,
  Calendar,
  Trash2,
  ChevronLeft,
  ChevronRight,
  FileText,
  Edit3,
  Move,
  Link,
  Youtube,
  Trello,
  User, // Ikona za Profil
  Target, // Ikona za ciljeve
  Instagram, 
  Facebook, 
  Move as TikTok,
  Plus,
  ClipboardList, 
  Eye,
  Heart
} from 'lucide-react';

// Funkcija za simulaciju generisanja YouTube Thumbnail URL-a iz ID-a
const getYoutubeThumbnail = (url) => {
    const regExp = /^.*(youtu.be\/|v\/|\/u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    const match = url.match(regExp);
    const videoId = (match && match[2].length === 11) ? match[2] : null;
    
    if (videoId) {
        // Vraƒáa high quality thumbnail
        return {
            url: `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`,
            type: 'youtube'
        };
    }
    return { url: null, type: 'link' };
};

// Funkcija za simulaciju parsiranja imena kanala/profila i generisanje mock ikone
const parseProfileDetails = (url, name) => {
    let iconUrl = `https://placehold.co/40x40/4f46e5/FFFFFF?text=${name.substring(0,2).toUpperCase()}`;
    let nicheId = 'marketing';
    
    // Provera za YouTube ikonu
    if (url.includes('youtube.com') || url.includes('youtu.be')) {
        iconUrl = 'https://placehold.co/40x40/FF0000/FFFFFF?text=YT';
    }
    // Provera za Instagram ikonu
    else if (url.includes('instagram.com')) {
        iconUrl = 'https://placehold.co/40x40/C13584/FFFFFF?text=IG';
    }
    // Provera za TikTok ikonu
    else if (url.includes('tiktok.com')) {
        iconUrl = 'https://placehold.co/40x40/000000/FFFFFF?text=TK';
    }

    // Dodatno, simulacija odabira ni≈°e na osnovu imena (vrlo osnovno)
    if (name.toLowerCase().includes('nekretnine') || name.toLowerCase().includes('real estate')) {
        nicheId = 'realestate';
    } else if (name.toLowerCase().includes('fitness') || name.toLowerCase().includes('zdravlje')) {
        nicheId = 'fitness';
    }
    
    const mockFeed = MOCK_COMPETITORS[Math.floor(Math.random() * MOCK_COMPETITORS.length)].feed;
    
    return {
        icon: iconUrl,
        niche: NICHES.find(n => n.id === nicheId)?.name || 'Marketing & Biznis',
        feed: mockFeed
    };
};


// --- MOCK DATA ---

const NICHES = [
  { id: 'marketing', name: 'Marketing & Biznis', icon: TrendingUp, color: 'text-blue-500' },
  { id: 'realestate', name: 'Nekretnine', icon: Home, color: 'text-emerald-500' },
  { id: 'fitness', name: 'Fitness & Zdravlje', icon: Dumbbell, color: 'text-rose-500' },
  { id: 'ecommerce', name: 'E-commerce', icon: ShoppingBag, color: 'text-purple-500' },
];

const NETWORKS = [
    { id: 'instagram', name: 'Instagram', icon: Instagram, color: 'text-rose-500' },
    { id: 'youtube', name: 'YouTube', icon: Youtube, color: 'text-red-600' },
    { id: 'tiktok', name: 'TikTok', icon: TikTok, color: 'text-slate-800' },
    { id: 'facebook', name: 'Facebook', icon: Facebook, color: 'text-blue-700' },
];

const VIRAL_TEMPLATES = {
  marketing: [
    {
      id: 'm1',
      title: 'Mit vs. Istina (30s Reel)',
      format: 'Kratka Forma',
      difficulty: 'Lako',
      views_potential: 'Visok',
      why_it_works: 'Ljudi vole da ƒçuju da su veƒáina "gurua" u krivu. Ovo gradi tvoj autoritet kroz kontroverzu.',
      structure: {
        hook: 'Svi vam govore da morate da radite [TOPIC], ali to je najveƒáa la≈æ u marketingu.',
        body: 'Istina je zapravo suprotna. Dok se svi fokusiraju na [TOPIC], pametni igraƒçi rade ovo: [RESENJE].',
        cta: 'Ako ≈æeli≈° da sazna≈° strategiju koja zapravo radi, proƒçitaj opis.'
      },
      vlads_tip: 'Snimaj ovo u krupnom planu (talking head). Govori malo ti≈°e nego obiƒçno, kao da odaje≈° tajnu.'
    },
    {
      id: 'm2',
      title: 'Iza Scene: Brojke (YouTube Video)',
      format: 'Duga Forma',
      difficulty: 'Srednje',
      views_potential: 'Veoma visok',
      why_it_works: 'Transparentnost gradi ogromno poverenje. Ljudi su voajeri, vole da vide tuƒëi novƒçanik/rezultate.',
      structure: {
        hook: 'Evo taƒçno koliko sam zaradio/potro≈°io na [TOPIC] u poslednjih 30 dana.',
        body: 'Nije sve i≈°lo glatko. Prva nedelja je bila katastrofa, ali onda se desilo ovo...',
        cta: 'Lajkuj, komentari≈°i i pretplati se za nedeljne izve≈°taje.'
      },
      vlads_tip: 'Prika≈æi ekran (screen recording) dok priƒça≈°. Dokaz je jaƒçi od priƒçe.'
    }
  ],
  realestate: [
    {
      id: 'r1',
      title: 'Tura luksuza (Reel / TikTok)',
      format: 'Kratka Forma',
      difficulty: 'Srednje',
      views_potential: 'Viralno',
      why_it_works: 'ASMR za oƒçi. Brzi rezovi dr≈æe pa≈ænju (retention), a luksuz izaziva aspiraciju.',
      structure: {
        hook: 'Ovo je ≈°ta [CENA] evra kupuje danas u [TOPIC].',
        body: 'Pogledajte ovu terasu... a tek kupatilo. Ali ƒçekajte da vidite glavnu spavaƒáu sobu.',
        cta: 'Da li biste ≈æiveli ovde? Pi≈°ite u komentarima.'
      },
      vlads_tip: 'Prve 3 sekunde moraju imati 6 kadrova. Muzika mora da bude u beatu sa rezovima.'
    }
  ],
  fitness: [
    {
      id: 'f1',
      title: 'Jedna Promena (30s Reel)',
      format: 'Kratka Forma',
      difficulty: 'Lako',
      views_potential: 'Srednje',
      why_it_works: 'Ljudima je dosta komplikovanih dijeta. ≈Ωele "magic bullet" re≈°enje.',
      structure: {
        hook: 'Prestao sam da radim [TOPIC] i salo je poƒçelo samo da se topi.',
        body: 'Mislio sam da je to kljuƒçno, ali zapravo mi je samo dizalo kortizol. Umesto toga...',
        cta: 'Probaj ovo 7 dana i javi mi rezultate.'
      },
      vlads_tip: 'Poka≈æi sliku "Pre i Posle" u prve 2 sekunde videa.'
    }
  ],
  ecommerce: [
    {
      id: 'e1',
      title: 'Proizvod u akciji (ASMR Reel)',
      format: 'Kratka Forma',
      difficulty: 'Srednje',
      views_potential: 'Visok',
      why_it_works: 'Zadovoljavajuƒái vizuelni sadr≈æaj. Ne prodaje≈° proizvod, prodaje≈° oseƒáaj kori≈°ƒáenja.',
      structure: {
        hook: '(Bez reƒçi, samo zvuk otvaranja/kori≈°ƒáenja [TOPIC])',
        body: 'Gledaj kako lako re≈°ava problem. Nema vi≈°e nereda, nema vi≈°e stresa.',
        cta: 'Link je u opisu profila.'
      },
      vlads_tip: 'Zvuk je ovde 50% videa. Koristi dobar mikrofon blizu proizvoda.'
    }
  ]
};

const KANBAN_COLUMNS = [
  { id: 'idea', title: 'üí° Ideja', color: 'border-yellow-500/50 bg-yellow-500/10 text-yellow-500' },
  { id: 'ready', title: 'üé¨ Spremno za snimanje', color: 'border-blue-500/50 bg-blue-500/10 text-blue-400' },
  { id: 'scheduled', title: 'üìÖ Zakazano', color: 'border-purple-500/50 bg-purple-500/10 text-purple-400' },
  { id: 'published', title: '‚úÖ Objavljeno', color: 'border-emerald-500/50 bg-emerald-500/10 text-emerald-400' }
];

// --- MOCK DATA FOR COMPETITORS ---
const MOCK_COMPETITORS = [
    {
        id: 'c1',
        name: 'Digital Guru YT',
        url: 'https://youtube.com/@digitalgurutv',
        icon: 'https://placehold.co/40x40/500099/FFFFFF?text=DG',
        niche: 'marketing',
        feed: [
            { id: 101, title: 'Kako AI pi≈°e Reels skripte za 5 minuta', views: '20K', date: '2025-12-01', type: 'reel' },
            { id: 102, title: 'Najveƒáa gre≈°ka u SEO 2024.', views: '5K', date: '2025-11-25', type: 'youtube' },
            { id: 103, title: '3 Alata za Content Automation', views: '12K', date: '2025-12-07', type: 'reel' },
        ]
    },
    {
        id: 'c2',
        name: 'Nekretnine BG',
        url: 'https://instagram.com/nekretninebg',
        icon: 'https://placehold.co/40x40/047857/FFFFFF?text=NBG',
        niche: 'realestate',
        feed: [
            { id: 201, title: 'Tura kroz stan od 300.000‚Ç¨ na Vraƒçaru', views: '50K', date: '2025-12-05', type: 'reel' },
            { id: 202, title: 'Da li je pravo vreme za kredit?', views: '15K', date: '2025-11-29', type: 'youtube' },
        ]
    },
    {
        id: 'c3',
        name: 'Fitnes Expert',
        url: 'https://tiktok.com/@fitnessexpert',
        icon: 'https://placehold.co/40x40/dc2626/FFFFFF?text=FE',
        niche: 'fitness',
        feed: [
            { id: 301, title: 'Jedna ve≈æba za trbu≈°njake u kuƒái', views: '150K', date: '2025-12-06', type: 'reel' },
            { id: 302, title: 'Moj plan ishrane za 2000 kcal', views: '20K', date: '2025-12-01', type: 'youtube' },
        ]
    }
];

// --- KOMPONENTA ZA PRAƒÜENJE CILJEVA ---
const GoalProgressDashboard = ({ progress, goals }) => {
    const { completedShort, completedLong, notification } = progress;
    const { monthlyGoalShort, monthlyGoalLong } = goals;

    const shortPercent = monthlyGoalShort > 0 ? (completedShort / monthlyGoalShort) * 100 : 0;
    const longPercent = monthlyGoalLong > 0 ? (completedLong / monthlyGoalLong) * 100 : 0;
    
    const getBarColor = (current, goal) => {
        const percent = goal > 0 ? (current / goal) : 0;
        if (percent >= 1) return 'bg-emerald-500'; // Cilj ispunjen
        if (percent >= 0.75) return 'bg-blue-500'; // Blizu cilja
        if (notification && notification.includes('ubrzati')) return 'bg-red-500'; // Upozorenje
        return 'bg-yellow-500'; // Normalan tempo, ali paziti
    };

    return (
        <div className="bg-slate-900/50 p-6 rounded-xl border border-slate-800 mb-8 shadow-inner">
            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-3">
                <Target size={20} className="text-yellow-400" /> Progres Meseƒçnih Ciljeva
            </h3>
            
            {notification && (
                <div className={`mb-4 p-3 rounded-lg border flex items-center gap-3 animate-pulse ${
                    notification.includes('ƒåestitamo') 
                        ? 'bg-emerald-800/50 border-emerald-700 text-emerald-300'
                        : 'bg-red-800/50 border-red-700 text-red-300'
                }`}>
                    <Zap size={20} />
                    <span className="font-semibold text-sm">{notification}</span>
                </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                {/* Short Form Goal */}
                <div>
                    <div className="flex justify-between items-center mb-1">
                        <span className="text-sm font-medium text-slate-300 flex items-center gap-1">
                             <Video size={16} className="text-red-400" /> Kratka Forma
                        </span>
                        <span className="text-xs text-white font-bold">
                            {completedShort} / {monthlyGoalShort}
                        </span>
                    </div>
                    <div className="w-full bg-slate-700 rounded-full h-3">
                        <div 
                            className={`h-3 rounded-full transition-all duration-500 ${getBarColor(completedShort, monthlyGoalShort)}`} 
                            style={{ width: `${Math.min(100, shortPercent)}%` }} 
                            title={`${shortPercent.toFixed(1)}%`}
                        ></div>
                    </div>
                </div>

                {/* Long Form Goal */}
                <div>
                    <div className="flex justify-between items-center mb-1">
                        <span className="text-sm font-medium text-slate-300 flex items-center gap-1">
                            <Youtube size={16} className="text-green-400" /> Duga Forma
                        </span>
                        <span className="text-xs text-white font-bold">
                            {completedLong} / {monthlyGoalLong}
                        </span>
                    </div>
                    <div className="w-full bg-slate-700 rounded-full h-3">
                        <div 
                            className={`h-3 rounded-full transition-all duration-500 ${getBarColor(completedLong, monthlyGoalLong)}`} 
                            style={{ width: `${Math.min(100, longPercent)}%` }} 
                            title={`${longPercent.toFixed(1)}%`}
                        ></div>
                    </div>
                </div>
            </div>
        </div>
    );
};
// --- END GOAL PROGRESS COMPONENT ---


const CaseStudyDetailModal = ({ task, onClose }) => {
    // ... (unchanged)
    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
            <div className="bg-slate-900 border border-slate-700 w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
                
                {/* Header */}
                <div className="flex items-center justify-between p-6 border-b border-slate-800">
                    <div>
                        <span className="text-xs font-bold text-slate-500 uppercase tracking-wider bg-slate-800 px-2 py-1 rounded border border-slate-700">
                            {task.niche} - {task.format}
                        </span>
                        <h3 className="2xl font-bold text-white mt-2">{task.title}</h3>
                        <p className="text-slate-400 text-sm mt-1">
                            Objavljeno: {task.publishDate ? new Date(task.publishDate).toLocaleDateString('sr-RS') : 'N/A'}
                        </p>
                    </div>
                    <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                        <X size={24} />
                    </button>
                </div>

                {/* Content */}
                <div className="p-6 overflow-y-auto flex-1 space-y-8">
                    
                    {/* Cover Image & Metrics */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="md:col-span-2">
                            <h4 className="text-sm font-bold text-slate-400 uppercase mb-3 flex items-center gap-2"><Eye size={16} className="text-blue-400"/> Vizuelni Kontekst</h4>
                            <div className="w-full bg-slate-800 rounded-xl overflow-hidden border border-slate-700 aspect-video flex items-center justify-center">
                                {task.coverImageUrl ? (
                                    <img src={task.coverImageUrl} alt="Video Thumbnail" className="w-full h-full object-cover" />
                                ) : (
                                    <span className="text-slate-500">Nema Cover Slike</span>
                                )}
                            </div>
                        </div>

                        {/* Metrics Sidebar */}
                        <div className="md:col-span-1 space-y-4">
                            <h4 className="text-sm font-bold text-slate-400 uppercase mb-3 flex items-center gap-2"><TrendingUp size={16} className="text-emerald-400"/> Rezultati</h4>
                            <div className="space-y-3">
                                <div className="bg-slate-800 p-3 rounded-lg border-l-4 border-emerald-500">
                                    <p className="text-xs uppercase text-emerald-400 font-bold">Pregleda (Views)</p>
                                    <p className="text-lg font-extrabold text-white">{task.resultViews || 'N/A'}</p>
                                </div>
                                <div className="bg-slate-800 p-3 rounded-lg border-l-4 border-purple-500">
                                    <p className="text-xs uppercase text-purple-400 font-bold">Anga≈æman (Engagement)</p>
                                    <p className="text-lg font-extrabold text-white">{task.resultEngagement || 'N/A'}</p>
                                </div>
                                <div className="bg-slate-800 p-3 rounded-lg border-l-4 border-yellow-500">
                                    <p className="text-xs uppercase text-yellow-400 font-bold">Konverzije</p>
                                    <p className="text-lg font-extrabold text-white">{task.resultConversions || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Duga Analiza */}
                    <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                        <h3 className="text-lg font-bold text-slate-300 mb-3 flex items-center gap-2"><Lightbulb size={18} className="text-blue-400" /> Detaljna Analiza uspeha:</h3>
                        <div className="text-slate-400 leading-relaxed whitespace-pre-wrap">
                            {task.analysis || 'Analiza jo≈° nije dodata za ovu studiju sluƒçaja.'}
                        </div>
                    </div>
                    
                    {/* ≈†ablon za ponavljanje */}
                    <div className="pt-4 border-t border-slate-800">
                        <h3 className="text-md font-bold text-slate-300 mb-2">Originalni ≈†ablon za replikaciju:</h3>
                        <p className="text-sm text-slate-500">
                            Ova objava je bazirana na ≈°ablonu: 
                            <span className="text-white ml-1 font-semibold">{task.originalTemplate || task.title}</span>
                        </p>
                    </div>
                    
                    {/* Linkovi (Inspiracija/Konkurenti) */}
                    {(task.inspirationLinks && task.inspirationLinks.length > 0) && (
                        <div className="pt-4 border-t border-slate-800">
                            <h3 className="text-md font-bold text-slate-300 mb-2">Inspiracija/Konkurenti:</h3>
                            <div className="flex flex-wrap gap-2">
                                {task.inspirationLinks.map(item => (
                                    <a key={item.id} href={item.link} target="_blank" rel="noopener noreferrer" 
                                        className="text-xs text-blue-400 hover:text-blue-300 bg-slate-800 px-3 py-1 rounded-full border border-slate-700 transition-colors"
                                    >
                                        {item.link.replace(/^https?:\/\//, '').substring(0, 30) + '...'}
                                    </a>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};


const SocialLinkInput = ({ socialLinks, setSocialLinks }) => {
    // ... (unchanged)
    const [linkInput, setLinkInput] = useState('');

    const handleAddLink = () => {
        if (!linkInput.trim()) return;
        
        const newLink = {
            id: Date.now().toString(),
            url: linkInput.trim(),
        };

        setSocialLinks([...socialLinks, newLink]);
        setLinkInput('');
    };

    const handleRemoveLink = (id) => {
        setSocialLinks(socialLinks.filter(link => link.id !== id));
    };

    return (
        <div className="space-y-4">
            <h4 className="text-sm font-bold text-slate-400 uppercase">Linkovi ka mre≈æama (za AI kontekst)</h4>
            
            <div className="flex gap-2">
                <input
                    type="url"
                    value={linkInput}
                    onChange={(e) => setLinkInput(e.target.value)}
                    placeholder='Link do profila (npr. YouTube, Instagram...)'
                    className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                />
                <button
                    onClick={handleAddLink}
                    disabled={!linkInput.trim()}
                    className="px-4 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium transition-colors disabled:bg-slate-700 disabled:text-slate-500"
                >
                    Dodaj
                </button>
            </div>

            <div className="space-y-2 max-h-48 overflow-y-auto">
                {socialLinks.map(item => (
                    <div key={item.id} className="bg-slate-700/50 p-3 rounded-lg flex justify-between items-center border border-slate-700">
                        <a href={item.url} target="_blank" rel="noopener noreferrer" className="text-xs text-blue-400 hover:underline truncate max-w-[80%]">
                            {item.url.replace(/^https?:\/\//, '').replace(/^www\./, '')}
                        </a>
                        <button
                            onClick={() => handleRemoveLink(item.id)}
                            className="text-slate-500 hover:text-red-400 transition-colors shrink-0"
                            title="Obri≈°i link"
                        >
                            <Trash2 size={16} />
                        </button>
                    </div>
                ))}
            </div>
        </div>
    );
};

const ProfileSettings = ({ profile, setProfile, onSave }) => {
    // ... (unchanged)
    const [isSaving, setIsSaving] = useState(false);
    const [socialLinks, setSocialLinks] = useState(profile.socialLinks || []);
    
    useEffect(() => {
        setSocialLinks(profile.socialLinks || []);
    }, [profile.socialLinks]);

    const handleSave = () => {
        setIsSaving(true);
        // Spajemo socijalne linkove sa ostatkom profila
        onSave({ ...profile, socialLinks });
        
        setTimeout(() => {
            setIsSaving(false);
        }, 500);
    };

    return (
        <div className="max-w-4xl mx-auto bg-slate-900/50 p-6 lg:p-10 rounded-3xl border border-slate-800 shadow-xl">
            <h1 className="text-3xl font-bold text-white mb-2 flex items-center gap-3">
                <User className="text-blue-400" size={24} /> Postavke Profila
            </h1>
            <p className="text-slate-400 mb-8">
                Ove informacije ƒáe AI koristiti za personalizaciju skripti, tona i poziva na akciju (CTA).
            </p>

            <div className="space-y-6">
                
                {/* Ime Biznisa */}
                <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">
                        Ime Biznisa / Liƒçni Brend
                    </label>
                    <input
                        type="text"
                        value={profile.businessName}
                        onChange={(e) => setProfile(p => ({ ...p, businessName: e.target.value }))}
                        placeholder='Npr. Biznis Priƒçe, Vlads Digital, Prodaja Nekretnina Beograd'
                        className="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                    />
                </div>

                {/* Ciljna Publika */}
                <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">
                        Ciljna Publika (Ko ≈æeli≈° da te gleda?)
                    </label>
                    <textarea
                        value={profile.targetAudience}
                        onChange={(e) => setProfile(p => ({ ...p, targetAudience: e.target.value }))}
                        placeholder='Npr. Vlasnici malih biznisa u Srbiji, stari 25-45, koji tek ulaze u svet digitalnog marketinga...'
                        className="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white placeholder-slate-500 resize-none h-24 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                    />
                </div>
                
                {/* Persona/Ton */}
                <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">
                        Persona / Ton (Kako zvuƒçi≈°?)
                    </label>
                    <input
                        type="text"
                        value={profile.persona}
                        onChange={(e) => setProfile(p => ({ ...p, persona: e.target.value }))}
                        placeholder='Npr. Struƒçan, motivi≈°uƒái, direktan, pun energije, koristi≈° humor'
                        className="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                    />
                </div>

                {/* NEW GOAL SETTING SECTION */}
                <div>
                    <h3 className="text-xl font-bold text-white mb-4 mt-6 border-t border-slate-700 pt-6 flex items-center gap-2">
                        <Target size={20} className="text-yellow-400" /> Meseƒçni Ciljevi Sadr≈æaja
                    </h3>
                    <p className="text-slate-400 text-sm mb-4">Postavite ciljeve za tekuƒái mesec za praƒáenje progresa.</p>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2 flex items-center gap-1">
                                <Video size={16} className="text-red-400" /> Kratka Forma (Reel/TikTok)
                            </label>
                            <input
                                type="number"
                                min="0"
                                value={profile.monthlyGoalShort}
                                onChange={(e) => setProfile(p => ({ ...p, monthlyGoalShort: Math.max(0, parseInt(e.target.value) || 0) }))}
                                className="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2 flex items-center gap-1">
                                <Youtube size={16} className="text-green-400" /> Duga Forma (YouTube)
                            </label>
                            <input
                                type="number"
                                min="0"
                                value={profile.monthlyGoalLong}
                                onChange={(e) => setProfile(p => ({ ...p, monthlyGoalLong: Math.max(0, parseInt(e.target.value) || 0) }))}
                                className="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                            />
                        </div>
                    </div>
                </div>
                {/* END NEW GOAL SETTING SECTION */}

                {/* Social Links */}
                <SocialLinkInput 
                    socialLinks={socialLinks} 
                    setSocialLinks={setSocialLinks}
                />

                <button
                    onClick={handleSave}
                    disabled={isSaving}
                    className={`w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 transition-all ${
                        isSaving 
                        ? 'bg-blue-800 text-blue-300' 
                        : 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/20'
                    }`}
                >
                    {isSaving ? (
                        <>ƒåuvanje...</>
                    ) : (
                        <>
                            <Check size={20} /> Saƒçuvaj Profil
                        </>
                    )}
                </button>
            </div>
        </div>
    );
};

// Nova komponenta za voƒëeno kreiranje ideje (Wizard)
const NewIdeaWizard = ({ onClose, onSaveToPlan }) => {
    const [step, setStep] = useState('start'); // 'start' | 'template_select' | 'script_edit'
    const [selectedNiche, setSelectedNiche] = useState('marketing');
    const [formData, setFormData] = useState({
        title: '',
        niche: NICHES[0].name,
        format: 'Kratka Forma',
        network: NETWORKS[0].name,
        fullScript: '',
        originalTemplate: null,
    });
    const [isSaving, setIsSaving] = useState(false);
    
    // Konfiguracija: 150 reƒçi po minuti za procenu trajanja videa
    const WORDS_PER_MINUTE = 150; 

    // Filtered templates for the selector step
    const activeTemplates = VIRAL_TEMPLATES[selectedNiche] || [];
    const activeNicheInfo = NICHES.find(n => n.id === selectedNiche);

    const handleSelectTemplate = (template) => {
        // Generisanje skripte (mock)
        const topic = formData.title || 'Moja Tema';
        
        // Povezivanje generisane skripte sa strukturom fullScript
        const generatedScript = template.format === 'Duga Forma' 
            ? `UVOD: U prve 3 sekunde ka≈æi za≈°to bi trebalo da ostanu do kraja.
            GLAVNA TEMA 1: ${template.structure.body.replace('[TOPIC]', topic).replace('[RESENJE]', 'koriste automatizaciju')}
            GLAVNA TEMA 2: Detaljna analiza i primer
            ZAKLJUƒåAK: ${template.structure.cta}` 
            : `HOOK:\n${template.structure.hook.replace('[TOPIC]', topic).replace('[CENA]', '150.000').replace('[RESENJE]', 'fokusiraju na LTV')}\n\nBODY:\n${template.structure.body.replace('[TOPIC]', topic).replace('[RESENJE]', 'koriste automatizaciju')}\n\nCTA:\n${template.structure.cta}`;

        setFormData(prev => ({
            ...prev,
            title: prev.title || template.title,
            format: template.format,
            originalTemplate: template.title,
            fullScript: generatedScript,
            niche: activeNicheInfo.name,
        }));
        setStep('script_edit');
    };
    
    const handleManualStart = () => {
        setFormData(prev => ({
            ...prev,
            fullScript: `HOOK:\nUnesite udicu ovde (0-3 sekunde)\n\nBODY:\nUnesite kljuƒçnu vrednost ovde (3-45 sekundi)\n\nCTA:\nUnesite poziv na akciju ovde`,
            originalTemplate: 'Ruƒçni Unos',
        }));
        setStep('script_edit');
    }

    const handleSave = () => {
        if (!formData.title.trim() || !formData.fullScript.trim()) return;

        setIsSaving(true);
        
        let hookText = '';
        let bodyText = '';
        let ctaText = '';

        if (formData.format === 'Kratka Forma') {
            // Logika za parsiranje Hook/Body/CTA ostaje ista za Kratku Formu
            // Za Kratku Formu, Parsiramo HOOK, BODY, CTA iz fullScript-a
            const scriptParts = formData.fullScript.split(/\n\n(HOOK|BODY|CTA):\n/);
            
            let currentTag = '';
            for (let i = 0; i < scriptParts.length; i++) {
                 const part = scriptParts[i].trim();
                 if (part === 'HOOK') {
                     currentTag = 'hook';
                 } else if (part === 'BODY') {
                     currentTag = 'body';
                 } else if (part === 'CTA') {
                     currentTag = 'cta';
                 } else if (currentTag === 'hook') {
                     hookText = part;
                     currentTag = '';
                 } else if (currentTag === 'body') {
                     bodyText = part;
                     currentTag = '';
                 } else if (currentTag === 'cta') {
                     ctaText = part;
                     currentTag = '';
                 } else if (i === 0) {
                      // Ako je prvi deo, a nije parsiran kao tag, tretiraj ga kao ceo tekst
                      hookText = part.split('\n')[0] || hookText; // Samo prva linija kao hook
                 }
            }
            // Ako je neuspelo parsiranje, koristi prve linije
            if (!hookText && formData.fullScript) {
                 const lines = formData.fullScript.split('\n').filter(line => line.trim() !== '');
                 hookText = lines[0] || '';
                 bodyText = lines[1] || '';
                 ctaText = lines[lines.length - 1] || '';
            }
        } else {
            // Logika za Dugu Formu: HOOK/BODY/CTA se popunjava iseƒçcima skripte (kako bi kanban kartica bila informativna)
            const cleanScript = formData.fullScript.replace(/\s+/g, ' ').trim();
            hookText = cleanScript.substring(0, Math.min(100, cleanScript.length)) + (cleanScript.length > 100 ? '...' : '');
            bodyText = 'CEO TEKST se nalazi u Hook/Skripta polju u detaljima.';
            ctaText = 'Duga Forma: Nema odvojenog CTA za Kanban.';
            
            // Postavljamo celu skriptu u HOOK polje za editovanje u TaskDetailModal
            // Polja body i cta su placeholderi
            // Zbog logike u TaskDetailModal, moramo celu skriptu da smestimo u hook
        }


        const newTask = {
            id: Date.now().toString(),
            title: formData.title.trim(),
            niche: formData.niche,
            format: formData.format,
            network: formData.network,
            hook: formData.format === 'Duga Forma' ? formData.fullScript.trim() : hookText.trim(), // Sme≈°tamo celu skriptu za Dugu Formu u Hook
            body: formData.format === 'Duga Forma' ? bodyText.trim() : bodyText.trim(), // Body je sada samo placeholder u Dugoj Formi
            cta: formData.format === 'Duga Forma' ? ctaText.trim() : ctaText.trim(), // CTA je sada samo placeholder u Dugoj Formi
            status: 'idea',
            inspirationLinks: [],
            publishDate: null,
            timestamp: new Date().toISOString(),
            originalTemplate: formData.originalTemplate,
        };

        onSaveToPlan(newTask);
        
        setTimeout(() => {
            setIsSaving(false);
            onClose();
        }, 500);
    };
    
    // Funkcija za procenu trajanja videa
    const getDurationEstimate = (script) => {
        if (formData.format === 'Kratka Forma') {
            // Procena za Kratku Formu
            const words = script.trim().split(/\s+/).length;
            const seconds = Math.round((words / 2.5)); // ~2.5 reƒçi po sekundi
            if (seconds > 60) return '> 60 sekundi (Predugo za Reel)';
            return `${seconds} sekundi`; 
        } else {
            // Procena za Dugu Formu (150 WPM)
            const words = script.trim().split(/\s+/).length;
            if (words === 0) return '0 minuta';
            
            const minutes = Math.round(words / WORDS_PER_MINUTE);
            
            if (minutes < 1) return '< 1 minut';
            if (minutes <= 60) return `${minutes} minuta`;
            
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            
            return `${hours}h ${remainingMinutes} min`;
        }
    }


    // Card component adapted for the modal
    const IdeaSelectorCard = ({ template }) => (
        <div className="group bg-slate-800 border border-slate-700 hover:border-blue-500/50 rounded-xl p-4 transition-all duration-300 hover:shadow-xl hover:shadow-blue-900/10 flex flex-col h-full cursor-pointer" onClick={() => handleSelectTemplate(template)}>
            <div className="flex justify-between items-start mb-2">
                <span className={`px-2 py-0.5 rounded-full text-[10px] font-bold ${template.format === 'Kratka Forma' ? 'bg-red-900/30 text-red-300' : 'bg-green-900/30 text-green-300'}`}>
                    {template.format}
                </span>
                <span className={`text-xs font-bold text-slate-500`}>
                    {template.difficulty}
                </span>
            </div>

            <h3 className="text-md font-bold text-white mb-2 group-hover:text-blue-400 transition-colors">
                {template.title}
            </h3>
            
            <p className="text-slate-400 text-xs mb-4 flex-grow line-clamp-2">
                {template.why_it_works}
            </p>

            <div className="mt-auto">
                <button 
                    className="w-full py-1.5 bg-blue-600 text-white rounded-lg font-bold text-xs hover:bg-blue-500 transition-colors flex items-center justify-center gap-1"
                >
                    <Zap size={14} /> Koristi ≈†ablon
                </button>
            </div>
        </div>
    );
    
    // UI Render
    const renderContent = () => {
        if (step === 'start') {
            return (
                <div className="p-6 space-y-6">
                    <h3 className="text-xl font-bold text-white">1. Odaberi Naƒçin Kreiranja Ideje</h3>
                    <div className="grid grid-cols-2 gap-4">
                        <div 
                            onClick={handleManualStart} 
                            className="p-6 bg-slate-800 border border-slate-700 rounded-xl hover:border-blue-500/50 cursor-pointer transition-all flex flex-col items-center text-center space-y-2"
                        >
                            <FileText size={24} className="text-blue-400" />
                            <p className="font-bold text-white">Ruƒçni Unos</p>
                            <p className="text-xs text-slate-400">Poƒçnite od nule sa praznom skriptom.</p>
                        </div>
                        <div 
                            onClick={() => setStep('template_select')} 
                            className="p-6 bg-slate-800 border border-slate-700 rounded-xl hover:border-emerald-500/50 cursor-pointer transition-all flex flex-col items-center text-center space-y-2"
                        >
                            <Zap size={24} className="text-emerald-400" />
                            <p className="font-bold text-white">Koristi ≈†ablon</p>
                            <p className="text-xs text-slate-400">Izaberite viralni format za brzi start.</p>
                        </div>
                    </div>
                </div>
            );
        }

        if (step === 'template_select') {
            return (
                <div className="p-6 space-y-6">
                    <div className="flex justify-between items-center mb-4">
                         <h3 className="text-xl font-bold text-white flex items-center gap-2">
                             <Zap className="text-yellow-400 w-5 h-5" /> 2. Odaberi ≈†ablon
                         </h3>
                         <button onClick={() => setStep('start')} className="text-slate-400 hover:text-white transition-colors text-sm flex items-center gap-1">
                             <ChevronLeft size={16} /> Nazad
                         </button>
                    </div>

                    {/* Niche Filter */}
                    <div className="flex flex-wrap gap-2 mb-4">
                        {NICHES.map(niche => (
                            <button
                                key={niche.id}
                                onClick={() => setSelectedNiche(niche.id)}
                                className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${
                                    selectedNiche === niche.id
                                    ? 'bg-blue-600 text-white'
                                    : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                                }`}
                            >
                                {niche.name}
                            </button>
                        ))}
                    </div>

                    {/* Template Grid */}
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4 max-h-[50vh] overflow-y-auto pr-2">
                        {activeTemplates.map(template => (
                            <IdeaSelectorCard key={template.id} template={template} />
                        ))}
                    </div>
                </div>
            );
        }
        
        if (step === 'script_edit') {
            const isLongForm = formData.format === 'Duga Forma';
            
            return (
                <div className="p-6 space-y-6 flex-1 flex flex-col">
                    <div className="flex items-center justify-between mb-2">
                        <h3 className="text-xl font-bold text-white flex items-center gap-2">
                            <Edit3 className="text-emerald-400 w-5 h-5" /> 3. Skripta i Detalji
                        </h3>
                         <button onClick={() => setStep('template_select')} className="text-slate-400 hover:text-white transition-colors text-sm flex items-center gap-1">
                            {formData.originalTemplate === 'Ruƒçni Unos' ? (
                                <>
                                    <ChevronLeft size={16} /> Nazad
                                </>
                            ) : (
                                <>
                                    <ChevronLeft size={16} /> Izaberi drugi ≈°ablon
                                </>
                            )}
                         </button>
                    </div>
                    
                    {/* Title */}
                    <div>
                        <label className="block text-sm font-medium text-slate-300 mb-2">Naslov Video Zapisa</label>
                        <input
                            type="text"
                            value={formData.title}
                            onChange={(e) => setFormData(p => ({ ...p, title: e.target.value }))}
                            placeholder='Unesite naslov (Npr. 3 Alata za Brzi Viral)'
                            className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                        />
                    </div>
                    
                    {/* Network Selector */}
                    <div>
                        <label className="block text-sm font-medium text-slate-300 mb-2">Mre≈æa za Objavljivanje</label>
                        <div className="flex gap-3">
                            {NETWORKS.map(net => {
                                const Icon = net.icon;
                                return (
                                    <button
                                        key={net.id}
                                        onClick={() => setFormData(p => ({ ...p, network: net.name, format: (net.id === 'youtube' || net.id === 'facebook') ? 'Duga Forma' : 'Kratka Forma' }))}
                                        className={`px-4 py-2 rounded-xl text-sm font-medium transition-colors border ${
                                            formData.network === net.name
                                            ? 'bg-blue-600 text-white border-blue-500'
                                            : 'bg-slate-800 text-slate-400 border-slate-700 hover:bg-slate-700'
                                        } flex items-center gap-2`}
                                    >
                                        <Icon size={16} className={formData.network === net.name ? 'text-white' : net.color} />
                                        {net.name}
                                    </button>
                                );
                            })}
                        </div>
                        <p className="text-xs text-slate-500 mt-2">
                            Automatski format: 
                            <span className={`ml-1 font-semibold ${formData.format === 'Kratka Forma' ? 'text-red-400' : 'text-green-400'}`}>
                                {formData.format}
                            </span>
                        </p>
                    </div>
                    
                    {/* Full Script Textarea */}
                    <div className="flex-1 flex flex-col min-h-[300px]">
                        <label className="block text-sm font-medium text-slate-300 mb-2">
                           {isLongForm ? 'Ceo Scenario / Tekst Duge Forme (YouTube)' : 'Skripta (Hook, Body, CTA) - Preporuƒçeno'}
                        </label>
                        <textarea
                            value={formData.fullScript}
                            onChange={(e) => setFormData(p => ({ ...p, fullScript: e.target.value }))}
                            placeholder={isLongForm ? 'Pi≈°ite ceo scenario, ukljuƒçujuƒái uvod, glavne taƒçke i zakljuƒçak. Nije potrebno odvajati sekcije.' : 'Pi≈°ite skriptu ovde. Razdvojte sekcije sa duplim enterom (prazna linija). Preporuƒçujemo format: HOOK:\n... BODY:\n... CTA:\n...'}
                            className="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white placeholder-slate-500 resize-none flex-1 min-h-[200px] font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                        />
                         <div className="text-xs text-slate-500 mt-2 flex justify-between items-center">
                            <span>
                                {isLongForm 
                                    ? `Procena Trajanja Videa: ${getDurationEstimate(formData.fullScript)} (~${WORDS_PER_MINUTE} WPM)`
                                    : 'Savet: Koristite format: HOOK: [tekst] / BODY: [tekst] / CTA: [tekst] za lak≈°e praƒáenje.'
                                }
                            </span>
                             <span className="text-slate-400 font-mono">{formData.fullScript.trim().split(/\s+/).length} reƒçi</span>
                         </div>
                    </div>

                    <div className="border-t border-slate-800 pt-6">
                        <button
                            onClick={handleSave}
                            disabled={isSaving || !formData.title.trim() || !formData.fullScript.trim()}
                            className={`w-full py-3 rounded-xl font-bold text-lg flex items-center justify-center gap-2 transition-all ${
                                isSaving || !formData.title.trim()
                                    ? 'bg-slate-700 text-slate-500 cursor-not-allowed' 
                                    : 'bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-900/20'
                            }`}
                        >
                            <Calendar size={20} /> {isSaving ? 'ƒåuvanje...' : 'Saƒçuvaj u Planer Sadr≈æaja'}
                        </button>
                    </div>
                </div>
            );
        }
    }


    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
            <div className="bg-slate-900 border border-slate-700 w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col max-h-[95vh] h-full md:h-auto">
                
                {/* Header */}
                <div className="flex items-center justify-between p-6 border-b border-slate-800 shrink-0">
                    <h3 className="text-xl font-bold text-white flex items-center gap-2">
                        <Plus className="text-emerald-400 w-5 h-5" />
                        Nova Ideja (ƒåarobnjak)
                    </h3>
                    <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                        <X size={24} />
                    </button>
                </div>
                
                {/* Content */}
                <div className="overflow-y-auto flex-1">
                    {renderContent()}
                </div>
            </div>
        </div>
    );
};


const TaskDetailModal = ({ task, onClose, onDelete, onUpdate }) => {
    // ... (MODIFIKOVAN KOD POƒåINJE OVDE)
    const [copied, setCopied] = useState(false);
    const [editedTask, setEditedTask] = useState(task);
    const [isSaving, setIsSaving] = useState(false);
    const [linkInput, setLinkInput] = useState('');
    const [activeTab, setActiveTab] = useState('script'); // 'script' | 'inspiration' | 'schedule' | 'results'

    const isLongForm = editedTask.format === 'Duga Forma';

    // Za Long Form, Hook polje sadr≈æi celu skriptu. Za short form, hook je samo hook.
    const initialScriptValue = isLongForm ? editedTask.hook : ''; 

    // Dodatni state za ceo tekst Duge Forme
    const [fullScriptText, setFullScriptText] = useState(initialScriptValue);

    const copyScript = () => {
        // Za Long Form kopiraj ceo tekst iz Full Script polja
        const textToCopy = isLongForm ? fullScriptText : `HOOK:\n${editedTask.hook}\n\nBODY:\n${editedTask.body}\n\nCTA:\n${editedTask.cta}`;
        navigator.clipboard.writeText(textToCopy);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
    };

    const handleUpdate = (field, value) => {
        setEditedTask(prev => ({ ...prev, [field]: value }));
    };

    const handleUpdateFullScript = (value) => {
        setFullScriptText(value);
    };

    const handleAddLink = () => {
        if (!linkInput.trim()) return;

        const { url, type } = getYoutubeThumbnail(linkInput);
        
        const newLink = {
            id: Date.now().toString(),
            link: linkInput.trim(),
            displayUrl: url, // Thumbnail URL if YouTube
            type: type
        };

        setEditedTask(prev => ({ 
            ...prev, 
            inspirationLinks: [...(prev.inspirationLinks || []), newLink]
        }));
        setLinkInput('');
    };

    const handleRemoveLink = (id) => {
        setEditedTask(prev => ({
            ...prev,
            inspirationLinks: prev.inspirationLinks.filter(link => link.id !== id)
        }));
    };

    const handleSave = () => {
        setIsSaving(true);
        
        const updatedTask = { ...editedTask };
        
        // A≈æuriranje Long Form Hooka pre ƒçuvanja
        if (isLongForm) {
             updatedTask.hook = fullScriptText;
             // Polja body i cta su placeholderi i ostaju isti, ali a≈æuriramo i naslov
             updatedTask.body = 'CEO TEKST se nalazi u Hook/Skripta polju u detaljima.';
             updatedTask.cta = 'Duga Forma: Nema odvojenog CTA za Kanban.';
        }

        onUpdate(updatedTask);
        // Simulate API call delay
        setTimeout(() => {
            setIsSaving(false);
            onClose();
        }, 500);
    };
    
    const taskFormat = editedTask.format === 'Kratka Forma' ? 'text-red-400' : 'text-green-400';

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
            <div className="bg-slate-900 border border-slate-700 w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
                
                {/* Header */}
                <div className="flex items-center justify-between p-6 border-b border-slate-800">
                    <div>
                        <span className="text-xs font-bold text-slate-500 uppercase tracking-wider bg-slate-800 px-2 py-1 rounded border border-slate-700">
                            {editedTask.niche}
                        </span>
                        <h3 className="text-xl font-bold text-white mt-2 flex items-center gap-2">
                           <span className={`text-sm font-bold ${taskFormat}`}>[{editedTask.format}]</span>
                           {editedTask.title}
                        </h3>
                        <p className="text-slate-400 text-xs mt-1">
                            Kreirano: {new Date(editedTask.timestamp).toLocaleDateString('sr-RS')}
                            {editedTask.publishDate && (
                                <span className="ml-3 font-semibold text-purple-300">
                                    | Planirano: {new Date(editedTask.publishDate).toLocaleDateString('sr-RS')}
                                </span>
                            )}
                        </p>
                    </div>
                    <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                        <X size={24} />
                    </button>
                </div>
                
                {/* Tabs */}
                <div className="flex border-b border-slate-800">
                    <button 
                        onClick={() => setActiveTab('script')}
                        className={`px-6 py-3 text-sm font-medium transition-colors flex items-center gap-2 ${activeTab === 'script' ? 'text-white border-b-2 border-blue-500' : 'text-slate-500 hover:text-slate-300'}`}
                    >
                        <FileText size={16} /> Skripta
                    </button>
                    <button 
                        onClick={() => setActiveTab('inspiration')}
                        className={`px-6 py-3 text-sm font-medium transition-colors flex items-center gap-2 ${activeTab === 'inspiration' ? 'text-white border-b-2 border-blue-500' : 'text-slate-500 hover:text-slate-300'}`}
                    >
                        <Link size={16} /> Inspiracija ({editedTask.inspirationLinks?.length || 0})
                    </button>
                    <button 
                        onClick={() => setActiveTab('schedule')}
                        className={`px-6 py-3 text-sm font-medium transition-colors flex items-center gap-2 ${activeTab === 'schedule' ? 'text-white border-b-2 border-blue-500' : 'text-slate-500 hover:text-slate-300'}`}
                    >
                        <Calendar size={16} /> Raspored
                    </button>
                     {editedTask.status === 'published' && (
                        <button 
                            onClick={() => setActiveTab('results')}
                            className={`px-6 py-3 text-sm font-medium transition-colors flex items-center gap-2 ${activeTab === 'results' ? 'text-white border-b-2 border-blue-500' : 'text-slate-500 hover:text-slate-300'}`}
                        >
                            <ClipboardList size={16} /> Rezultati
                        </button>
                     )}
                </div>

                {/* Content */}
                <div className="p-6 overflow-y-auto flex-1 space-y-6">
                    {activeTab === 'script' && (
                        <div className="bg-slate-800 rounded-xl p-4 border border-slate-700 space-y-4">
                            <h4 className="text-sm font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                                <Edit3 size={14} className="text-blue-400"/> 
                                Skripta (Edit) - 
                                <span className={`ml-1 font-bold ${isLongForm ? 'text-green-400' : 'text-red-400'}`}>
                                    {editedTask.format}
                                </span>
                            </h4>
                            
                            {isLongForm ? (
                                <div className="flex-1 flex flex-col min-h-[300px]">
                                    <label className="text-green-400 text-xs font-bold block mb-1">CEO SCENARIO / TEKST (Duga Forma)</label>
                                    <textarea
                                        value={fullScriptText}
                                        onChange={(e) => handleUpdateFullScript(e.target.value)}
                                        placeholder='Pi≈°ite ceo scenario bez razdvajanja na HOOK/BODY/CTA'
                                        className="w-full bg-slate-700 p-3 rounded-lg text-white resize-none flex-1 min-h-[350px] font-mono text-sm focus:ring-2 focus:ring-green-500/50 focus:outline-none"
                                    />
                                     <p className="text-xs text-slate-500 mt-2">
                                        *Napomena: Za Dugu Formu koristi se jedno polje. Procena trajanja bi bila: **~{Math.round(fullScriptText.trim().split(/\s+/).length / 150)} min**
                                     </p>
                                </div>
                            ) : (
                                <>
                                    {/* Short Form Fields */}
                                    <div>
                                        <label className="text-red-400 text-xs font-bold block mb-1">01. HOOK (Udica)</label>
                                        <textarea 
                                            value={editedTask.hook}
                                            onChange={(e) => handleUpdate('hook', e.target.value)}
                                            className="w-full bg-slate-700 p-3 rounded-lg text-white resize-none h-20 focus:ring-2 focus:ring-red-500/50 focus:outline-none"
                                        />
                                    </div>

                                    {/* Body Field */}
                                    <div>
                                        <label className="text-blue-400 text-xs font-bold block mb-1">02. BODY (Vrednost)</label>
                                        <textarea 
                                            value={editedTask.body}
                                            onChange={(e) => handleUpdate('body', e.target.value)}
                                            className="w-full bg-slate-700 p-3 rounded-lg text-slate-300 resize-none h-32 focus:ring-2 focus:ring-blue-500/50 focus:outline-none"
                                        />
                                    </div>
                                    
                                    {/* CTA Field */}
                                    <div>
                                        <label className="text-emerald-400 text-xs font-bold block mb-1">03. CTA (Poziv na akciju)</label>
                                        <textarea 
                                            value={editedTask.cta}
                                            onChange={(e) => handleUpdate('cta', e.target.value)}
                                            className="w-full bg-slate-700 p-3 rounded-lg text-white font-medium resize-none h-16 focus:ring-2 focus:ring-emerald-500/50 focus:outline-none"
                                        />
                                    </div>
                                </>
                            )}
                        </div>
                    )}

                    {activeTab === 'inspiration' && (
                        <div className="space-y-4">
                            <h4 className="text-sm font-bold text-slate-400 uppercase mb-4 flex items-center gap-2"><Trello size={14} className="text-yellow-400"/> Dodaj Linkove Konkurenata</h4>
                            
                            <div className="flex gap-2">
                                <input
                                    type="url"
                                    value={linkInput}
                                    onChange={(e) => setLinkInput(e.target.value)}
                                    placeholder='Paste link (YouTube, Instagram, TikTok...)'
                                    className="flex-1 bg-slate-800 border border-slate-700 rounded-lg p-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                                />
                                <button
                                    onClick={handleAddLink}
                                    disabled={!linkInput.trim()}
                                    className="px-4 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-medium transition-colors disabled:bg-slate-700 disabled:text-slate-500"
                                >
                                    Dodaj
                                </button>
                            </div>

                            {/* Links List */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                                {(editedTask.inspirationLinks || []).length === 0 ? (
                                    <div className="col-span-full text-center py-10 text-slate-600 border-2 border-dashed border-slate-800 rounded-xl">
                                        Nema dodatih linkova za inspiraciju.
                                    </div>
                                ) : (
                                    (editedTask.inspirationLinks || []).map(item => (
                                        <div key={item.id} className="bg-slate-800 rounded-lg overflow-hidden border border-slate-700 relative group">
                                            {item.displayUrl && item.type === 'youtube' ? (
                                                <div className="relative">
                                                    <img src={item.displayUrl} alt="YouTube Thumbnail" className="w-full h-full object-cover" onError={(e) => e.target.style.display = 'none'} />
                                                    <Youtube size={32} fill="red" className="text-white absolute inset-0 m-auto opacity-70 group-hover:opacity-100 transition-opacity" />
                                                </div>
                                            ) : (
                                                <div className="p-3 text-sm text-slate-400 bg-slate-700/50 flex items-center gap-2">
                                                    <Link size={16} className="text-blue-400" />
                                                    Eksterni Link
                                                </div>
                                            )}
                                            <div className="p-3 flex justify-between items-center">
                                                <a href={item.link} target="_blank" rel="noopener noreferrer" className="text-xs text-blue-400 hover:underline truncate max-w-[80%]">
                                                    {item.link.replace(/^https?:\/\//, '').replace(/^www\./, '')}
                                                </a>
                                                <button
                                                    onClick={() => handleRemoveLink(item.id)}
                                                    className="text-slate-600 hover:text-red-400 transition-colors shrink-0"
                                                    title="Obri≈°i link"
                                                >
                                                    <Trash2 size={16} />
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    )}
                    
                    {activeTab === 'schedule' && (
                         <div className="space-y-4">
                            <h4 className="text-sm font-bold text-slate-400 uppercase mb-4 flex items-center gap-2"><Calendar size={14} className="text-purple-400"/> Datum Objavljivanja</h4>
                            
                            <label className="block text-sm font-medium text-slate-300 mb-2">
                                Planirani Datum
                            </label>
                            <input
                                type="date"
                                value={editedTask.publishDate ? editedTask.publishDate.substring(0, 10) : ''}
                                onChange={(e) => handleUpdate('publishDate', e.target.value ? new Date(e.target.value).toISOString() : null)}
                                className="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                            />
                            
                            {editedTask.publishDate && (
                                <button
                                    onClick={() => handleUpdate('publishDate', null)}
                                    className="text-red-400 text-sm hover:text-red-300 flex items-center gap-1 mt-2"
                                >
                                    <Trash2 size={14} /> Ukloni Datum
                                </button>
                            )}
                        </div>
                    )}

                    {editedTask.status === 'published' && activeTab === 'results' && (
                        <div className="space-y-4">
                            <h4 className="text-sm font-bold text-slate-400 uppercase mb-4 flex items-center gap-2"><Eye size={14} className="text-emerald-400"/> Analiza Rezultata (za Case Study)</h4>
                            
                            {/* Analiza (Longer Text Area) */}
                            <div>
                                <label className="text-blue-400 text-xs font-bold block mb-1">Detaljna Analiza (Za≈°to je radilo?)</label>
                                <textarea 
                                    value={editedTask.analysis || ''}
                                    onChange={(e) => handleUpdate('analysis', e.target.value)}
                                    placeholder='Opi≈°ite detaljno za≈°to je ova objava bila uspe≈°na i koje ste lekcije nauƒçili.'
                                    className="w-full bg-slate-700 p-3 rounded-lg text-slate-300 resize-none h-32 focus:ring-2 focus:ring-blue-500/50 focus:outline-none"
                                />
                            </div>

                            {/* Metrics Inputs */}
                            <div className="grid grid-cols-3 gap-4">
                                <div>
                                    <label className="text-emerald-400 text-xs font-bold block mb-1">Pregleda (Views)</label>
                                    <input 
                                        type="text"
                                        value={editedTask.resultViews || ''}
                                        onChange={(e) => handleUpdate('resultViews', e.target.value)}
                                        className="w-full bg-slate-700 p-3 rounded-lg text-white"
                                    />
                                </div>
                                <div>
                                    <label className="text-purple-400 text-xs font-bold block mb-1">Anga≈æman (Engagement)</label>
                                    <input 
                                        type="text"
                                        value={editedTask.resultEngagement || ''}
                                        onChange={(e) => handleUpdate('resultEngagement', e.target.value)}
                                        className="w-full bg-slate-700 p-3 rounded-lg text-white"
                                    />
                                </div>
                                <div>
                                    <label className="text-yellow-400 text-xs font-bold block mb-1">Konverzije</label>
                                    <input 
                                        type="text"
                                        value={editedTask.resultConversions || ''}
                                        onChange={(e) => handleUpdate('resultConversions', e.target.value)}
                                        className="w-full bg-slate-700 p-3 rounded-lg text-white"
                                    />
                                </div>
                            </div>
                             {/* Cover Image URL */}
                            <div>
                                <label className="text-red-400 text-xs font-bold block mb-1">Cover Slika URL (Thumbnail)</label>
                                <input 
                                    type="url"
                                    value={editedTask.coverImageUrl || ''}
                                    onChange={(e) => handleUpdate('coverImageUrl', e.target.value)}
                                    placeholder='Paste link do slike (ili YouTube link za automatski thumbnail)'
                                    className="w-full bg-slate-700 p-3 rounded-lg text-white"
                                />
                                {editedTask.coverImageUrl && (
                                    <div className="mt-2 text-xs text-slate-500">
                                        Trenutna slika: <img src={editedTask.coverImageUrl} alt="Preview" className="h-10 w-auto inline-block ml-2 rounded" />
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
                
                {/* Footer Actions */}
                <div className="p-6 border-t border-slate-800 flex justify-end gap-3">
                     <button 
                         onClick={handleSave}
                         disabled={isSaving}
                         className={`py-3 px-6 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors ${
                             isSaving ? 'bg-blue-800 text-blue-300' : 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/20'
                         }`}
                     >
                         {isSaving ? 'ƒåuvanje...' : (
                            <>
                                <Check size={18} />
                                Saƒçuvaj Izmene i Zatvori
                            </>
                         )}
                     </button>
                </div>
            </div>
        </div>
    );
};


const KanbanBoard = ({ tasks, onMoveTask, onDeleteTask, onTaskClick, onTaskDrop, onNewIdea }) => {
    // ... (unchanged)
  const [draggedTaskId, setDraggedTaskId] = useState(null);

  const handleDragStart = (e, taskId) => {
      setDraggedTaskId(taskId);
      e.dataTransfer.setData('taskId', taskId);
      e.dataTransfer.effectAllowed = 'move';
  };

  const handleDragOver = (e) => {
      e.preventDefault(); // Necessary to allow dropping
      e.dataTransfer.dropEffect = 'move';
  };

  const handleDrop = (e, columnId) => {
      e.preventDefault();
      const taskId = e.dataTransfer.getData('taskId');
      if (taskId) {
          onTaskDrop(taskId, columnId);
      }
      setDraggedTaskId(null);
  };

  return (
    <div className="h-full overflow-x-auto pb-4">
      <div className="flex gap-6 min-w-[1000px] h-full">
        {KANBAN_COLUMNS.map((column, colIndex) => {
          const columnTasks = tasks.filter(t => t.status === column.id);
          return (
            <div 
                key={column.id} 
                className="w-80 flex flex-col h-full"
                onDragOver={handleDragOver}
                onDrop={(e) => handleDrop(e, column.id)}
            >
              <div className={`flex items-center gap-2 p-3 rounded-t-xl border-t border-x border-slate-700/50 ${column.color} bg-opacity-10`}>
                <span className="font-bold text-sm">{column.title}</span>
                <span className="ml-auto bg-slate-900/50 px-2 py-0.5 rounded text-xs opacity-70">
                  {columnTasks.length}
                </span>
              </div>
              
              <div className={`flex-1 bg-slate-900/30 border-x border-b border-slate-800 rounded-b-xl p-3 space-y-3 overflow-y-auto min-h-[500px] transition-colors ${draggedTaskId ? 'bg-slate-900/50 border-dashed border-slate-700' : ''}`}>
                
                {column.id === 'idea' && (
                    <button 
                        onClick={onNewIdea}
                        className="w-full py-2 rounded-lg border-2 border-dashed border-slate-700 text-slate-500 hover:text-blue-400 hover:border-blue-500/50 transition-colors flex items-center justify-center gap-2 mb-3"
                    >
                        <Plus size={16} /> Dodaj Novu Ideju
                    </button>
                )}

                {columnTasks.map((task) => (
                  <div 
                    key={task.id}
                    draggable
                    onDragStart={(e) => handleDragStart(e, task.id)}
                    onClick={() => onTaskClick(task)}
                    className="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-sm hover:border-blue-500/50 hover:shadow-lg hover:shadow-blue-900/10 transition-all cursor-pointer group relative active:cursor-grabbing"
                  >
                    <div className="flex justify-between items-start mb-2 pointer-events-none">
                        <span className="text-[10px] uppercase tracking-wider font-bold text-slate-500 bg-slate-900 px-2 py-1 rounded">
                            {task.niche}
                        </span>
                        {/* More options (visual only for now) */}
                        <Move size={14} className="text-slate-600 opacity-50" />
                    </div>
                    <h4 className="font-bold text-white text-sm mb-3 leading-snug pointer-events-none">{task.title}</h4>
                    
                    <div className="flex items-center justify-between mt-4 pt-3 border-t border-slate-700/50">
                        <span className={`px-2 py-0.5 text-[10px] rounded-full font-bold ${task.format === 'Kratka Forma' ? 'bg-red-900/30 text-red-300' : 'bg-green-900/30 text-green-300'}`}>
                            {task.format}
                        </span>
                        
                        <span className="text-xs text-slate-500 font-mono pointer-events-none">
                             {task.publishDate ? new Date(task.publishDate).toLocaleDateString('sr-RS', {day: '2-digit', month: '2-digit'}) : new Date(task.timestamp).toLocaleDateString('sr-RS', {day: '2-digit', month: '2-digit'})}
                        </span>

                        <button 
                            disabled={colIndex === KANBAN_COLUMNS.length - 1}
                            onClick={(e) => { e.stopPropagation(); onMoveTask(task.id, KANBAN_COLUMNS[colIndex + 1].id); }}
                            className={`p-1.5 rounded hover:bg-slate-700 text-slate-400 ${colIndex === KANBAN_COLUMNS.length - 1 ? 'opacity-0 cursor-default' : ''}`}
                            title="Pomeri desno"
                        >
                            <ChevronRight size={16} />
                        </button>
                    </div>
                  </div>
                ))}
                
                {columnTasks.length === 0 && column.id !== 'idea' && (
                    <div className="text-center py-10 text-slate-600 text-sm border-2 border-dashed border-slate-800 rounded-lg pointer-events-none">
                        Prevuci ovde
                    </div>
                )}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
};

const CalendarView = ({ tasks, onTaskClick }) => {
    // ... (unchanged)
    const now = new Date();
    const daysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
    
    // Funkcija za dobijanje poƒçetka sedmice (Ponedeljak)
    const getStartOfWeek = (date) => {
        const d = new Date(date);
        const day = d.getDay(); // 0 = Nedelja, 1 = Ponedeljak...
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Prvi dan sedmice (Ponedeljak)
        return new Date(d.setDate(diff));
    };

    const startDate = getStartOfWeek(new Date(now.getFullYear(), now.getMonth() - 1, 1)); // Poƒçinje od prve sedmice pro≈°log meseca
    const endDate = new Date(now.getFullYear(), now.getMonth() + 2, daysInMonth(now.getFullYear(), now.getMonth() + 2));
    
    const days = [];
    let currentDay = new Date(startDate);

    // Iteriraj kroz dane
    while (currentDay <= endDate) {
        days.push(new Date(currentDay));
        currentDay.setDate(currentDay.getDate() + 1);
    }
    
    // Grupiranje zadataka po datumu objave
    const tasksByDate = tasks
        .filter(t => t.publishDate)
        .reduce((acc, task) => {
            const date = new Date(task.publishDate).toDateString();
            if (!acc[date]) {
                acc[date] = [];
            }
            acc[date].push(task);
            return acc;
        }, {});

    const isToday = (date) => date.toDateString() === now.toDateString();
    const isPast = (date) => date < new Date(now.getFullYear(), now.getMonth(), now.getDate());

    return (
        <div className="bg-slate-900/30 rounded-xl border border-slate-800 p-3 h-full overflow-y-auto">
            <div className="grid grid-cols-7 gap-px text-center text-xs font-bold text-slate-400 mb-2">
                {['PON', 'UTO', 'SRE', 'ƒåET', 'PET', 'SUB', 'NED'].map(day => (
                    <div key={day} className="py-2">{day}</div>
                ))}
            </div>

            <div className="grid grid-cols-7 gap-px">
                {days.map((day, index) => {
                    const dateString = day.toDateString();
                    const dayTasks = tasksByDate[dateString] || [];
                    const isOtherMonth = day.getMonth() !== now.getMonth() && (day < now || day > new Date(now.getFullYear(), now.getMonth() + 1, 0));
                    
                    const dayClasses = `
                        p-1 h-28 border border-slate-800/50 rounded-lg overflow-hidden transition-all duration-100 relative
                        ${isToday(day) ? 'bg-blue-600/20 border-blue-500' : 'bg-slate-800/20 hover:bg-slate-700/20'}
                        ${isOtherMonth ? 'opacity-40' : ''}
                    `;
                    
                    return (
                        <div key={index} className={dayClasses}>
                            <div className={`text-sm font-bold absolute top-1 right-2 ${isToday(day) ? 'text-blue-300' : 'text-slate-300'}`}>
                                {day.getDate()}
                            </div>
                            
                            <div className="space-y-1 mt-6 px-1">
                                {dayTasks.map(task => {
                                    const pastTask = isPast(day);
                                    return (
                                        <div 
                                            key={task.id}
                                            onClick={() => onTaskClick(task)}
                                            className={`
                                                px-2 py-1 rounded-md text-xs font-medium truncate cursor-pointer shadow-md border 
                                                ${pastTask ? 'bg-slate-700 text-slate-400 opacity-50 border-slate-600' : 'bg-blue-600/80 text-white hover:bg-blue-500 border-blue-700'}
                                                transition-opacity
                                            `}
                                            title={task.title}
                                        >
                                            {task.format === 'Kratka Forma' ? 'üé•' : 'üì∫'} {task.title}
                                        </div>
                                    );
                                })}
                            </div>

                        </div>
                    );
                })}
            </div>
        </div>
    );
};

const CaseStudyView = ({ tasks, onCaseStudyClick }) => {
    // ... (unchanged)
    const publishedTasks = tasks.filter(t => t.status === 'published');

    return (
        <>
            <header className="mb-8">
                <h1 className="text-3xl font-bold text-white mb-2 flex items-center gap-3">
                    <ClipboardList className="text-emerald-400" size={24} /> Studije Sluƒçaja
                </h1>
                <p className="text-slate-400 max-w-2xl">
                    Analizirane objave koje su ostvarile najbolje rezultate. Kliknite na karticu za detaljnu analizu.
                </p>
            </header>

            <div className="space-y-8">
                {publishedTasks.length === 0 ? (
                    <div className="py-20 text-center border-2 border-dashed border-slate-800 rounded-2xl">
                        <p className="text-slate-500">Jo≈° uvek nema objavljenih studija. Prebacite karticu u status 'Objavljeno' u Planeru Sadr≈æaja za analizu.</p>
                    </div>
                ) : (
                    publishedTasks.map((task) => (
                        <div 
                            key={task.id} 
                            onClick={() => onCaseStudyClick(task)}
                            className="bg-slate-900 border border-slate-700 rounded-2xl p-6 shadow-xl hover:border-blue-500/50 transition-all duration-300 cursor-pointer"
                        >
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                
                                {/* Image / Context */}
                                <div className="md:col-span-1">
                                    <div className="w-full bg-slate-800 rounded-xl overflow-hidden aspect-video border border-slate-700 flex items-center justify-center relative">
                                        {task.coverImageUrl ? (
                                            <img src={task.coverImageUrl} alt="Video Cover" className="w-full h-full object-cover" onError={(e) => e.target.style.display = 'none'} />
                                        ) : (
                                            <span className="text-slate-500 text-sm">Cover Slika</span>
                                        )}
                                        <span className={`absolute top-2 left-2 px-2 py-0.5 text-[10px] rounded-full font-bold ${task.format === 'Kratka Forma' ? 'bg-red-900/70 text-red-300' : 'bg-green-900/70 text-green-300'} backdrop-blur-sm`}>
                                            {task.format}
                                        </span>
                                    </div>
                                </div>

                                {/* Analysis (Emphasized) */}
                                <div className="md:col-span-2">
                                    <h2 className="text-xl font-bold text-white mb-1">{task.title}</h2>
                                    <p className="text-xs text-slate-500 mb-3">{task.niche} | ≈†ablon: {task.originalTemplate || 'N/A'}</p>

                                    <h3 className="text-md font-bold text-slate-300 mb-2 flex items-center gap-2"><Lightbulb size={16} className="text-blue-400" /> Kljuƒçna Analiza:</h3>
                                    <p className="text-slate-400 text-sm italic line-clamp-3">
                                        {task.analysis || 'Nema dodate analize za≈°to je ovaj video pro≈°ao viralno.'}
                                    </p>
                                    
                                    {/* Small Metrics Row */}
                                    <div className="flex flex-wrap gap-4 mt-4 pt-3 border-t border-slate-800">
                                        <div className="flex items-center gap-1 text-xs text-emerald-400">
                                            <Eye size={14} /> <span>{task.resultViews || 'N/A'}</span>
                                        </div>
                                        <div className="flex items-center gap-1 text-xs text-purple-400">
                                            <Heart size={14} /> <span>{task.resultEngagement || 'N/A'}</span>
                                        </div>
                                        <div className="flex items-center gap-1 text-xs text-yellow-400">
                                            <Target size={14} /> <span>{task.resultConversions || 'N/A'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </>
    );
}

// --- NOVE KOMPONENTE ZA KONKURENTE ---

const CompetitorFeedModal = ({ competitor, onClose }) => {
    // ... (unchanged)
    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
            <div className="bg-slate-900 border border-slate-700 w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
                
                <div className="flex items-center justify-between p-6 border-b border-slate-800">
                    <div className="flex items-center gap-3">
                        {/* Kori≈°ƒáenje dobavljene ikone */}
                        <img src={competitor.icon} alt={competitor.name} className="w-10 h-10 rounded-full object-cover border-2 border-blue-500" />
                        <div>
                            <h3 className="text-xl font-bold text-white">{competitor.name}</h3>
                            <p className="text-slate-400 text-sm">{competitor.url.split('/')[2]}</p>
                        </div>
                    </div>
                    <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                        <X size={24} />
                    </button>
                </div>

                <div className="p-6 overflow-y-auto flex-1 space-y-4">
                    <h4 className="text-sm font-bold text-slate-400 uppercase">Poslednje 3 Objavljene Teme (Mock Feed)</h4>
                    {competitor.feed.map(post => (
                        <div key={post.id} className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
                            <div>
                                <p className="font-medium text-white text-sm flex items-center gap-2">
                                    {post.type === 'reel' ? <Video size={16} className="text-red-400" /> : <Youtube size={16} className="text-green-400" />}
                                    {post.title}
                                </p>
                                <p className="text-xs text-slate-500 mt-1">
                                    Objavljeno: {post.date} | Pregledi: {post.views}
                                </p>
                            </div>
                            <a href={competitor.url} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:text-blue-400 shrink-0">
                                <Link size={18} />
                            </a>
                        </div>
                    ))}
                    <a 
                        href={competitor.url} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="w-full text-center block mt-6 py-2 bg-slate-700 text-slate-300 rounded-lg hover:bg-slate-600 transition-colors text-sm"
                    >
                        Idi na {competitor.name} Profil
                    </a>
                </div>
            </div>
        </div>
    );
};


const CompetitorsView = ({ competitors, onCompetitorClick, onAddCompetitor, onRemoveCompetitor }) => {
    // ... (unchanged)
    const [linkInput, setLinkInput] = useState('');
    const [nameInput, setNameInput] = useState('');

    const handleAdd = () => {
        if (!linkInput.trim() || !nameInput.trim()) return;

        // Kori≈°ƒáenje nove funkcije za parsiranje detalja i mock feed
        const profileDetails = parseProfileDetails(linkInput.trim(), nameInput.trim());
        
        const newCompetitor = {
            id: Date.now().toString(),
            name: nameInput.trim(),
            url: linkInput.trim(),
            icon: profileDetails.icon,
            niche: profileDetails.niche,
            feed: profileDetails.feed 
        };

        onAddCompetitor(newCompetitor);
        setLinkInput('');
        setNameInput('');
    };

    return (
        <>
            <header className="mb-8">
                <h1 className="text-3xl font-bold text-white mb-2 flex items-center gap-3">
                    <Trello className="text-blue-400" size={24} /> Konkurenti
                </h1>
                <p className="text-slate-400 max-w-2xl">
                    Pratite i analizirajte najuspe≈°nije objave va≈°ih konkurenata da biste prona≈°li nove virale ≈°ablone.
                </p>
            </header>

            {/* Dodavanje Konkurenta */}
            <div className="bg-slate-900 border border-slate-800 p-6 rounded-xl mb-8 space-y-4">
                <h3 className="text-xl font-bold text-white">Dodaj Novog Konkurenta</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input
                        type="text"
                        value={nameInput}
                        onChange={(e) => setNameInput(e.target.value)}
                        placeholder='Ime Konkurenta (npr. Digital Guru)'
                        className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all md:col-span-1"
                    />
                    <input
                        type="url"
                        value={linkInput}
                        onChange={(e) => setLinkInput(e.target.value)}
                        placeholder='Link ka Profilu (YouTube, TikTok, Instagram...)'
                        className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all md:col-span-1"
                    />
                    <button
                        onClick={handleAdd}
                        disabled={!linkInput.trim() || !nameInput.trim()}
                        className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium transition-colors disabled:bg-slate-700 disabled:text-slate-500 md:col-span-1 flex items-center justify-center gap-2"
                    >
                        <Plus size={18} /> Dodaj Listi
                    </button>
                </div>
            </div>
            
            {/* Lista Konkurenata */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                {competitors.length === 0 ? (
                    <div className="col-span-full py-10 text-center border-2 border-dashed border-slate-800 rounded-xl">
                        <p className="text-slate-500">Nema dodatih konkurenata na listi.</p>
                    </div>
                ) : (
                    competitors.map(comp => (
                        <div key={comp.id} className="bg-slate-800 border border-slate-700 rounded-xl p-4 flex flex-col justify-between hover:border-blue-500/50 transition-colors">
                            <div 
                                onClick={() => onCompetitorClick(comp)}
                                className="flex items-center gap-3 cursor-pointer group"
                            >
                                {/* Prikaz slike profila (Mock) */}
                                <img src={comp.icon} alt={comp.name} className="w-10 h-10 rounded-full object-cover shrink-0" />
                                <div>
                                    <p className="font-bold text-white group-hover:text-blue-400 transition-colors">{comp.name}</p>
                                    {/* Prikaz dobavljene ni≈°e */}
                                    <p className="text-xs text-slate-500">{comp.niche}</p>
                                </div>
                            </div>
                            <div className="flex justify-end gap-2 mt-3 pt-3 border-t border-slate-700">
                                <button
                                    onClick={() => onCompetitorClick(comp)}
                                    className="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-500 text-white rounded-lg flex items-center gap-1"
                                >
                                    <Eye size={14} /> Feed
                                </button>
                                <button
                                    onClick={() => onRemoveCompetitor(comp.id)}
                                    className="p-1.5 text-slate-500 hover:text-red-400 hover:bg-slate-700 rounded-lg"
                                    title="Obri≈°i"
                                >
                                    <Trash2 size={16} />
                                </button>
                            </div>
                        </div>
                    ))
                )}
            </div>
        </>
    );
};


export default function ViralVaultApp() {
  const [selectedNiche, setSelectedNiche] = useState('marketing');
  const [currentView, setCurrentView] = useState('planner'); // Default je sada 'planner'
  const [plannerView, setPlannerView] = useState('kanban'); 
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  
  // Novi state za Idea Wizard
  const [isNewIdeaWizardOpen, setIsNewIdeaWizardOpen] = useState(false); 

  const [selectedTask, setSelectedTask] = useState(null); 
  const [selectedCaseStudy, setSelectedCaseStudy] = useState(null); 
  const [selectedCompetitor, setSelectedCompetitor] = useState(null); 
  
  // Novi state za Profil (ukljuƒçuje i ciljeve)
  const [profile, setProfile] = useState({
      businessName: 'Vlads Digital',
      targetAudience: 'Vlasnici malih biznisa i content kreatori u regionu, koji ≈æele da koriste AI za br≈æi rast.',
      persona: 'Struƒçan, direktan, motivi≈°uƒái, fokusiran na ROI (povrat investicije).',
      socialLinks: [
          { id: '1', url: 'https://youtube.com/@vladsdigital' },
          { id: '2', url: 'https://instagram.com/vladsdigital' },
      ],
      monthlyGoalShort: 20, // NOVO: Cilj za kratku formu (Reel/TikTok)
      monthlyGoalLong: 4,    // NOVO: Cilj za dugu formu (YouTube)
  });

  // Tasks State
  const [tasks, setTasks] = useState([
    {
        id: '1',
        title: 'Mit vs. Istina: Email Marketing',
        niche: 'Marketing',
        format: 'Kratka Forma',
        hook: 'Svi vam govore da je email mrtav, ali...',
        body: 'Email ima ROI od 4200%. Dok vi jurite TikTok trendove, va≈°i konkurenti ovde prave novac.',
        cta: 'Prijavite se na moj newsletter za besplatan template.',
        status: 'idea',
        inspirationLinks: [],
        publishDate: new Date(new Date().setDate(new Date().getDate() + 4)).toISOString(), // Buduƒánost
        timestamp: new Date().toISOString(),
        originalTemplate: 'Mit vs. Istina (30s Reel)',
    },
    {
        id: '2',
        title: 'Iza Scene: YouTube Monetizacija 2024 (Case Study)',
        niche: 'Marketing',
        format: 'Duga Forma',
        hook: 'UVOD: U prve 3 sekunde ka≈æi za≈°to bi trebalo da ostanu do kraja. GLAVNA TEMA 1: Nije sve i≈°lo glatko. Prva nedelja je bila katastrofa, ali onda se desilo ovo... GLAVNA TEMA 2: Detaljna analiza i primer ZAKLJUƒåAK: Lajkuj, komentari≈°i i pretplati se za nedeljne izve≈°taje.',
        body: 'CEO TEKST se nalazi u Hook/Skripta polju u detaljima.',
        cta: 'Duga Forma: Nema odvojenog CTA za Kanban.',
        status: 'published', // PUBLISHED STATUS
        inspirationLinks: [{
            id: 'l1',
            link: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
            displayUrl: 'https://i.ytimg.com/vi/dQw4w9WgXcQ/hqdefault.jpg',
            type: 'youtube'
        }],
        publishDate: new Date(new Date().setDate(new Date().getDate() - 3)).toISOString(), // Pro≈°lost
        timestamp: new Date().toISOString(),
        originalTemplate: 'Iza Scene: Brojke (YouTube Video)',
        coverImageUrl: 'https://i.ytimg.com/vi/dQw4w9WgXcQ/hqdefault.jpg', // SIMULIRANA SLIKA
        resultViews: '1.2M',
        resultEngagement: '85k lajkova / 1200 komentara',
        resultConversions: '320 novih pretplatnika',
        analysis: `Viralno je pro≈°lo zbog transparentnosti. Gledaoci su cenili sirove brojke. Fokus na "propast" u prvoj nedelji je poveƒáao zadr≈æavanje publike (retention).
        
        Detaljnije: Segment "prva nedelja je bila katastrofa" je izazvao emocionalnu vezu. Ljudi su se poistovetili sa neuspehom pre trijumfa. Takoƒëe, kljuƒçno je ≈°to smo uveli krupni plan dok se priƒçalo o ROI, ≈°to je poveƒáalo trust faktor. Zakljuƒçak: Uvek ubaci element neuspeha/izazova u prve 2 minute videa.`
    }
  ]);

    // Competitors State
    const [competitors, setCompetitors] = useState(MOCK_COMPETITORS);
    const handleAddCompetitor = (newComp) => {
        setCompetitors(prev => [...prev, newComp]);
    };

    const handleRemoveCompetitor = (id) => {
        setCompetitors(prev => prev.filter(c => c.id !== id));
    };


  const activeTemplates = VIRAL_TEMPLATES[selectedNiche] || [];
  const activeNicheInfo = NICHES.find(n => n.id === selectedNiche);

  const handleSaveToPlan = (script) => {
      const newTask = {
          id: Date.now().toString(),
          ...script,
          inspirationLinks: script.inspirationLinks || [], // Osiguraj da je prazan niz
          status: script.status || 'idea',
          originalTemplate: script.originalTemplate || null,
          publishDate: script.publishDate || null,
          coverImageUrl: script.coverImageUrl || null,
          resultViews: script.resultViews || null,
          resultEngagement: script.resultEngagement || null,
          resultConversions: script.resultConversions || null,
          analysis: script.analysis || null,
      };
      setTasks([...tasks, newTask]);
  };

  const handleMoveTask = (taskId, newStatus) => {
      setTasks(tasks.map(t => t.id === taskId ? { ...t, status: newStatus } : t));
  };

  const handleDeleteTask = (taskId) => {
      setTasks(tasks.filter(t => t.id !== taskId));
  };

  const handleUpdateTask = (updatedTask) => {
      
      // Ako je task iz Case Study-ja, poku≈°aj da parsira thumbnail
      const parsedTask = { ...updatedTask };
      if (updatedTask.status === 'published' && updatedTask.coverImageUrl && updatedTask.coverImageUrl.includes('youtube')) {
           const { url } = getYoutubeThumbnail(updatedTask.coverImageUrl);
           if (url) {
               parsedTask.coverImageUrl = url;
           }
      }

      setTasks(tasks.map(t => t.id === updatedTask.id ? parsedTask : t));
  };
  
  const handleUpdateProfile = (updatedProfile) => {
      setProfile(updatedProfile);
      // U stvarnoj aplikaciji, ovde bi i≈°ao API poziv za ƒçuvanje na server
  };

  // --- NOVO: LOGIKA ZA PRAƒÜENJE PROGRESA CILJEVA ---
  const calculateProgress = (tasks, goals) => {
    const publishedTasks = tasks.filter(t => t.status === 'published');
    
    const completedShort = publishedTasks.filter(t => t.format === 'Kratka Forma').length;
    const completedLong = publishedTasks.filter(t => t.format === 'Duga Forma').length;
    
    const now = new Date();
    // Odreƒëivanje tekuƒáeg meseca
    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    const dayOfMonth = now.getDate();
    const daysElapsed = dayOfMonth;

    // Pro-rata: ≈°ta bi trebalo da bude zavr≈°eno do danas
    const completionRatio = daysElapsed / daysInMonth;
    
    const requiredShort = Math.ceil(goals.monthlyGoalShort * completionRatio);
    const requiredLong = Math.ceil(goals.monthlyGoalLong * completionRatio);
    
    let notification = null;

    if (goals.monthlyGoalShort > 0 && completedShort < requiredShort) {
        notification = `Kratka forma: Zaostajete (${completedShort}/${requiredShort} potrebno). Ubrzajte kreiranje!`;
    } else if (goals.monthlyGoalLong > 0 && completedLong < requiredLong) {
        notification = `Duga forma: Zaostajete (${completedLong}/${requiredLong} potrebno). Ubrzajte kreiranje!`;
    } else if (completedShort >= goals.monthlyGoalShort && completedLong >= goals.monthlyGoalLong) {
        notification = "ƒåestitamo! Svi ciljevi za ovaj mesec su veƒá ispunjeni. Kreirajte dalje!";
    }

    return {
        completedShort,
        completedLong,
        requiredShort,
        requiredLong,
        notification
    };
  };

  const progress = calculateProgress(tasks, profile); 
  // --- KRAJ LOGIKE ZA CILJEVE ---

  return (
    <div className="min-h-screen bg-slate-950 text-slate-200 font-sans selection:bg-blue-500/30">
      
      {/* Mobile Header */}
      <div className="lg:hidden flex items-center justify-between p-4 bg-slate-900 border-b border-slate-800 sticky top-0 z-40">
        <div className="font-bold text-xl text-white tracking-tighter flex items-center gap-2">
           <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
             <Play fill="white" size={16} className="text-white" />
           </div>
           ViralVault
        </div>
        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 text-slate-400">
          {isSidebarOpen ? <X /> : <Menu />}
        </button>
      </div>

      <div className="flex">
        
        {/* Sidebar */}
        <aside 
          className={`fixed inset-y-0 left-0 z-30 w-64 bg-slate-900 border-r border-slate-800 transform transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:h-screen ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}
        >
          <div className="p-6">
            <div className="font-bold text-2xl text-white tracking-tighter flex items-center gap-2 mb-10 hidden lg:flex">
              <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                <Play fill="white" size={16} className="text-white" />
              </div>
              ViralVault
            </div>

            <div className="space-y-6">
                
                {/* AKCIJA: NOVA IDEJA (Glavni poziv na akciju) */}
                <button 
                    onClick={() => { setIsNewIdeaWizardOpen(true); setIsSidebarOpen(false); }}
                    className="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 mb-6 bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-900/20 font-bold"
                >
                    <Plus size={20} />
                    <span>Nova Ideja</span>
                </button>
                
                {/* Main Navigation */}
                <div>
                    <p className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 px-2">Aplikacija</p>
                    {/* Uklonjen Generator Ideja iz navigacije */}
                    
                    <button 
                        onClick={() => { setCurrentView('planner'); setIsSidebarOpen(false); }}
                        className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 mb-2 ${
                            currentView === 'planner'
                            ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' 
                            : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                        }`}
                    >
                        <Layout size={20} />
                        <span className="font-medium">Planer Sadr≈æaja</span>
                    </button>
                    <button 
                        onClick={() => { setCurrentView('competitors'); setIsSidebarOpen(false); }}
                        className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 mb-2 ${
                            currentView === 'competitors'
                            ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' 
                            : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                        }`}
                    >
                        <Trello size={20} />
                        <span className="font-medium">Konkurenti</span>
                    </button>
                    <button 
                        onClick={() => { setCurrentView('casestudy'); setIsSidebarOpen(false); }}
                        className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 mb-2 ${
                            currentView === 'casestudy'
                            ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' 
                            : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                        }`}
                    >
                        <ClipboardList size={20} />
                        <span className="font-medium">Studije Sluƒçaja</span>
                    </button>
                    
                </div>
            </div> {/* Closes <div className="space-y-6"> */}
          </div> {/* Closes <div className="p-6"> */}
          
            {/* Profil - Preme≈°ten na dno */}
            <div className="absolute bottom-0 w-full p-6 border-t border-slate-800">
                <button 
                    onClick={() => { setCurrentView('profile'); setIsSidebarOpen(false); }}
                    className="w-full flex items-center gap-3 p-2 rounded-xl transition-all duration-200 hover:bg-slate-800"
                >
                    <div className={`w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold text-white ${currentView === 'profile' ? 'ring-2 ring-blue-500' : ''}`}>
                        {profile.businessName ? profile.businessName.substring(0, 2).toUpperCase() : 'VL'}
                    </div>
                    <div className="text-left">
                        <p className="text-sm font-medium text-white">{profile.businessName || 'Moj Profil'}</p>
                        <p className="text-xs text-slate-500">Postavke & Nalog</p>
                    </div>
                    <User size={20} className="ml-auto text-slate-400" />
                </button>
            </div>
        </aside>

        {/* Main Content */}
        <main className="flex-1 p-4 lg:p-8 overflow-x-hidden h-screen overflow-y-auto">
          
          {/* DISCOVER VIEW JE ZAMENJEN PLANNER VIEW-om */}
          {currentView === 'discover' && (
              <div className="py-20 text-center border-2 border-dashed border-slate-800 rounded-2xl">
                <h2 className="text-xl font-bold text-white mb-4">Funkcionalnost je premje≈°tena!</h2>
                <p className="text-slate-500">
                    Katalog ≈°ablona i kreiranje ideja su sada integrisani u akciju 
                    <span className="font-bold text-emerald-400 mx-1">"Nova Ideja"</span>
                     koja se nalazi u Planeru Sadr≈æaja i u navigacionom panelu.
                </p>
                <button 
                    onClick={() => setCurrentView('planner')}
                    className="mt-6 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-medium transition-colors flex items-center gap-2 mx-auto"
                >
                    Idi na Planer Sadr≈æaja
                </button>
              </div>
          )}

          {currentView === 'planner' && (
            <>
                <header className="mb-8 flex items-center justify-between">
                    <div>
                        <h1 className="text-3xl font-bold text-white mb-2 flex items-center gap-3">
                        Planer Sadr≈æaja
                        </h1>
                        <p className="text-slate-400">
                        {plannerView === 'kanban' ? "Prevucite kartice (Drag 'n Drop) da promenite status ili kliknite za detalje." : "Vizuelno planiranje objava. Past obaveze su zatamnjene."}
                        </p>
                    </div>
                    <div className="flex gap-3">
                        {plannerView === 'kanban' && (
                           <button 
                                onClick={() => setIsNewIdeaWizardOpen(true)}
                                className="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-medium text-sm transition-colors flex items-center gap-2"
                            >
                                <Plus size={16} /> Nova Ideja
                            </button>
                        )}
                        <div className="bg-slate-800 px-4 py-2 rounded-lg text-sm text-slate-400 border border-slate-700 hidden md:block">
                            Ukupno ideja: <span className="text-white font-bold ml-1">{tasks.length}</span>
                        </div>
                        <div className="flex bg-slate-800 rounded-xl p-1 border border-slate-700">
                            <button
                                onClick={() => setPlannerView('kanban')}
                                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 ${plannerView === 'kanban' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-700'}`}
                            >
                                <Trello size={16} /> Kanban
                            </button>
                            <button
                                onClick={() => setPlannerView('calendar')}
                                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 ${plannerView === 'calendar' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-700'}`}
                            >
                                <Calendar size={16} /> Kalendar
                            </button>
                        </div>
                    </div>
                </header>
                
                {/* PROGRESS DASHBOARD */}
                <GoalProgressDashboard 
                    progress={progress} 
                    goals={profile} 
                />
                
                {plannerView === 'kanban' ? (
                    <KanbanBoard 
                        tasks={tasks} 
                        onMoveTask={handleMoveTask}
                        onDeleteTask={handleDeleteTask}
                        onTaskClick={setSelectedTask}
                        onTaskDrop={handleMoveTask}
                        onNewIdea={() => setIsNewIdeaWizardOpen(true)} // Otvara Wizard
                    />
                ) : (
                    <CalendarView
                        tasks={tasks}
                        onTaskClick={setSelectedTask}
                    />
                )}
            </>
          )}
          
          {currentView === 'competitors' && (
             <CompetitorsView
                 competitors={competitors}
                 onCompetitorClick={setSelectedCompetitor}
                 onAddCompetitor={handleAddCompetitor}
                 onRemoveCompetitor={handleRemoveCompetitor}
             />
          )}

          {currentView === 'casestudy' && (
             <CaseStudyView 
                 tasks={tasks}
                 onCaseStudyClick={setSelectedCaseStudy}
             />
          )}

          {currentView === 'profile' && (
             <ProfileSettings
                profile={profile}
                setProfile={setProfile}
                onSave={handleUpdateProfile}
             />
          )}

        </main>
      </div>

      {/* New Idea Wizard (Sve u jednom modal) */}
      {isNewIdeaWizardOpen && (
        <NewIdeaWizard
            onClose={() => setIsNewIdeaWizardOpen(false)}
            onSaveToPlan={handleSaveToPlan}
        />
      )}

      {/* Task Detail Modal */}
      {selectedTask && (
          <TaskDetailModal
            task={selectedTask}
            onClose={() => setSelectedTask(null)}
            onDelete={handleDeleteTask}
            onUpdate={handleUpdateTask} 
          />
      )}

      {/* Case Study Detail Modal */}
      {selectedCaseStudy && (
          <CaseStudyDetailModal
              task={selectedCaseStudy}
              onClose={() => setSelectedCaseStudy(null)}
          />
      )}
      
      {/* Competitor Feed Modal */}
      {selectedCompetitor && (
          <CompetitorFeedModal
              competitor={selectedCompetitor}
              onClose={() => setSelectedCompetitor(null)}
          />
      )}

    </div>
  );
}